<!DOCTYPE html>
<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <script src="recommendations.js"></script>
    <link rel="stylesheet" href="style.css">
    <title>Soil Moisture Monitoring and Recommendations</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <script>
        const prepItems = () => {
            fetch('http://plantsaver.peppersalt.info:5000/moisture', {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*'
                }
            }).then(function (response) {
                return response.json();
            }).then(function (data) {
                document.getElementById('moistureRecommendation').innerHTML = recommendPlantCareSoil(data.moisture_levels[data.moisture_levels.length - 1].level * 100);
            }).catch(function (err) {
                console.log(err);
            });
            new Chart(
                document.getElementById('moisture').getContext('2d'),
                {
                    type: 'line',
                    data: {
                        labels: [].map(row => row.created_at),
                        datasets: [
                            {
                                label: 'Moisture Level (%)',
                                data: [].map(row => row.level * 100)
                            }
                        ]
                    }
                }
            );
        }
        window.onload = prepItems;
        const getMoistureData = () => {
            fetch('http://plantsaver.peppersalt.info:5000/moisture', {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*'
                }
            }).then(function (response) {
                return response.json();
            }).then(function (data) {
                var chart = Chart.getChart('moisture');
                chart.data.datasets[0].data = data.moisture_levels.map(row => row.level * 100);
                chart.data.labels = data.moisture_levels.map(row => row.created_at);
                chart.update();
            }).catch(function (err) {
                console.log(err);
            });
            document.getElementById("charts-container").classList.remove("graybox");
            document.getElementById("recommendations").classList.remove("graybox");
        }
        window.setInterval(getMoistureData, 1000);
    </script>
</head>

<body>
    <div class="page-title fade-slide-in">Soil Moisture Monitoring and Recommendations</div>
    <div id="charts-container" class="fade-slide-in graybox">
        <div class="chart"><canvas id="moisture"></canvas></div>
    </div>
    <div id="recommendations" class="fade-slide-in graybox">
        Recommendations: <li>
            <ul id="moistureRecommendation"></ul>
        </li>
    </div>
</body>

</html>